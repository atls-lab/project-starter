# Pipeline: Code Review (PR + local)

## Цель
- Ревью предсказуемое, проверяемое, без галлюцинаций, без воды, с минимальным расходом токенов.

## Вход
- PR URL или `org/repo#prNumber`.
- Если ревью локально (без GitHub/PR контекста) - попроси PR URL (если он существует): из него берёшь ветку/дифф/задачу.
- Если PR URL нет - ветка/коммит(ы) + ссылка на задачу/тикет.

## Нон-голы (чтоб не расползалось)
- Не переписывай архитектуру "как надо".
- Не трогай код вне диффа, кроме точечного контекста для понимания (см. "Контекст по месту").
- Не заявляй, что "всё ок", если не можешь это проверить.

## Локальное ревью (без GitHub)
- Если нет PR URL/gh доступа, ревьюй локальный дифф `base..head` (или список коммитов) и явно пометь, что GitHub-данных/CI/ревью-истории нет.
- Если для нормального вердикта не хватает входных данных (задача, критерии, окружение, способ прогона) - задай уточняющие вопросы.
- Лимит вопросов: максимум 3. Не растягивай переписку: спрашивай только то, без чего ревью будет гаданием.

## Сбор данных (минимум)
1. PR мета + список файлов + HEAD SHA.
```bash
gh pr view <pr> -R <org/repo> \
  --json title,body,baseRefName,headRefName,headRefOid,files,commits,author
```
2. Дифф PR (только то, что реально меняется).
```bash
gh pr diff <pr> -R <org/repo>
```
3. Проверки/CI статус (без фантазий про тесты).
```bash
gh pr checks <pr> -R <org/repo>
```
4. История ревью и комменты (чтоб не повторяться).
```bash
gh api repos/<org>/<repo>/pulls/<pr>/reviews
gh api repos/<org>/<repo>/pulls/<pr>/comments
```
5. Инструкции репо.
   - Прочитать: `.agents/AGENTS.md`
   - Всегда прочитать, если есть: `.agents/instructions/project.md`
   - Прочитать по месту: `.agents/instructions/**` (только то, что соответствует зоне изменений, максимум 2 файла)
   - Зачем: эти правила влияют на вердикт (что тут считается блокером, что запрещено, какой формат ответа обязателен).

## Контекст задачи (обязателен)
1. Если есть PR URL, в PR body найди ссылку на issue/task (GitHub issue, Jira, etc).
   - Приоритет:
     - явная ссылка `https://...`;
     - `#123` если это issue этого же репо.
2. Если ревью локальное (без PR URL), бери ссылку на задачу из входных данных (`ветка/коммит(ы) + ссылка на задачу/тикет`).
   - Если ссылка не передана, помечай `Task: missing`.
   - Для изменений только в доках/формате это не блокер.
   - Для кода/контрактов это блокер: `CHANGES_REQUESTED` с запросом ссылки и критериев.
3. Если ссылка есть - прочитай постановку и критерии.
```bash
gh issue view <issue> -R <org/repo>
```
4. Если ссылки нет:
   - если PR/локальный дифф меняет что-то кроме док/комментов/форматтинга: это блокер -> `CHANGES_REQUESTED` с просьбой добавить ссылку и критерии;
   - если изменения чисто дока/формат: `COMMENT` и всё равно попроси ссылку (не блокером).

## Контекст по месту (строго дозировано)
- По умолчанию: смотри только дифф.
- Если в диффе видишь вызов/тип/контракт, который неочевиден:
  - открой ровно один уровень рядом: файл декларации/интерфейса/схемы, который этот кусок трогает;
  - контекст-бюджет на весь PR: `min(8, 2 + floor(M/10))` доп. файлов, где `M` = кол-во изменённых файлов в PR;
  - не читай папку целиком, не делай "обзор проекта".

## Anti-duplicate (жёстко)
- Перед тем как постить ревью:
  - возьми `headRefOid`;
  - проверь, есть ли уже ревью от этого бота на этот SHA (в PR reviews это `commit_id`).
- Если есть:
  - не пость новое ревью;
  - максимум `COMMENT` в треде, если реально нашёл новый `high` риск.

## Экономия токенов (жёстко)
- Не вставляй дифф и простыни кода в ревью.
- Цитаты из кода: максимум 1-2 строки, только если без этого непонятно.
- Не пересказывай PR body и issue body, вытяни только критерии/ограничения.

## Как ревьюить дифф (детерминированно)
Порядок проверок (не меняй порядок):
1. Контракты и совместимость:
   - публичные API/CLI/env/config/схемы/миграции/форматы данных;
   - обратная совместимость, деградации, миграционные шаги.
2. Корректность:
   - edge-cases, null/undefined, ошибки, таймауты, ретраи;
   - идемпотентность, порядок операций, побочки.
3. Безопасность и данные:
   - токены/секреты/PII в логах;
   - инъекции, небезопасные сериализации, обходы auth.
4. Надёжность и эксплуатация:
   - конфиги, флаги, откаты, наблюдаемость (метрики/логи), rate limit.
5. Тесты:
   - есть ли тесты на новую/изменённую логику;
   - если тестов нет, но риск есть -> `P2` finding с конкретным тест-кейсом.
6. Читабельность (только если не мешает остальному):
   - кривые нейминги, магия без констант, копипаста.

## Пруфы из PR body (если есть)
- Пруфы обычно идут в PR body после ссылки на задачу.
- Какие пруфы проверять (по приоритету):
  1) логи/вывод команд (CI, локальный запуск, миграции, деплой);
  2) примеры запросов/ответов (curl/httpie, payload, headers, коды, body);
  3) скрины (UI, графики, настройки);
  4) видео/ссылки на видео (ручной флоу).
- Для каждого пруфа ставь статус: `valid` / `partial` / `invalid` / `none`.
- `valid` только если одновременно:
  - ясно, что делали (шаги/команда/входные данные);
  - можно связать с PR (есть SHA/ссылка на run/артефакт, или прямо написано "tested on <headRefOid>");
  - результат реально подтверждает заявленное изменение из диффа.
- `partial`, если пруф есть, но:
  - нет SHA/непонятно окружение/не хватает входных данных/обрезан вывод/видео без шагов;
  - или ты физически не можешь проверить (нет доступа к окружению/артефактам).
- `invalid`, если пруф противоречит диффу или не относится к изменениям.
- `none`, если пруфов нет.
- Если статус `partial/invalid/none`, и PR меняет поведение/контракт/данные - добавь `P2` finding с конкретным запросом: "добавь <тип пруфа> и покажи <что именно>".

## Findings (формат и лимиты)
- Пиши findings только с привязкой к месту в коде (файл + строка/ханк).
- Каждый finding - один блок, формат как карточка:
  - `P0|P1|P2` + короткий заголовок
  - 2-4 коротких предложения (без простыней)
  - путь файла (с новой строки)
  - один конкретный фикс (без альтернатив)
- Для локального ревью в Codex desktop публикуй findings как UI-карточки через `::code-comment{...}` с `file` и `start/end`.
- Если UI-директивы недоступны, отдавай тот же finding обычным текстом в секции `Findings`.
- Максимум: 10 findings на весь PR. Если хочется больше - режь до топ-рисков и явно напиши "PR слишком жирный для 1 прохода".

## Приоритеты
- `P0` - прям сейчас горит: секьюрность/утечка/потеря данных/ломает контракт/необратимые миграции.
- `P1` - высокий риск поломки или баг почти гарантирован.
- `P2` - улучшайзинг: тесты, пруфы, эксплуатация, читаемость, но без явного "сломает прод".

## Вердикт (без креатива)
- Если есть `P0` или `P1` -> `CHANGES_REQUESTED`.
- Иначе если есть `P2` -> `COMMENT`.
- Иначе -> `APPROVED`.

## Итоговый формат ревью (один, всегда одинаковый)
1. `Summary`
   - 2-4 буллета: что поменялось по факту (только из диффа)
2. `Context`
   - `Task:` ссылка + 1-3 буллета критериев (или `missing`)
3. `Reviewed`
   - `Files:` `reviewed N/M` + список пропущенных файлов (если есть) и почему
4. `Findings`
   - `P0` -> `P1` -> `P2`
5. `Proofs`
   - `valid` / `partial` / `invalid` / `none`
6. `CI`
   - список чеков из `gh pr checks` + что фейлится/пропущено
7. `Verdict`
   - `APPROVED` / `COMMENT` / `CHANGES_REQUESTED`
